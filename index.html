<!DOCTYPE html>
<html lang="es">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-color: #1e293b; --border-color: #e2e8f0; --bg-switch: #f1f5f9; }
    .dark-mode { --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-color: #f1f5f9; --border-color: #334155; --bg-switch: #334155; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-color); height: 100vh; overflow: hidden; }
    .input-base { width: 100%; padding: 1rem; border-radius: 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); outline: none; }
    #amount { font-size: 4.5rem; font-weight: 800; color: #3b82f6; text-align: center; border: none; background: transparent; outline: none; width: 100%; }
    .scroll-container { display: flex; overflow-x: auto; gap: 0.6rem; padding: 0.5rem 0; scrollbar-width: none; }
    .scroll-container::-webkit-scrollbar { display: none; }
    .scroll-button { flex: 0 0 auto; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600; border-radius: 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); }
    .scroll-button.selected { background: #3b82f6 !important; color: white !important; border-color: #3b82f6; }
    .nav-floating { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 2rem; padding: 0.5rem; display: flex; justify-content: space-around; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); z-index: 1000; }
    .view-section { flex: 1; overflow-y: auto; display: none; padding-bottom: 120px; height: calc(100vh - 80px); }
    .view-section.active { display: block; }
    .record-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1.25rem; padding: 1rem; margin-bottom: 0.75rem; }
    .date-picker-custom { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 0.75rem; padding: 0.5rem; font-size: 0.8rem; font-weight: 700; outline: none; flex: 1; }
    #loading-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div id="loader-spinner" class="spinner mb-4"></div>
    <div id="loader-success" class="hidden mb-4"><svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <p id="loading-text" class="font-black text-blue-600 uppercase tracking-widest text-xs">Cargando...</p>
  </div>

  <header class="flex justify-between items-center p-5 sticky top-0 bg-[var(--bg-primary)] z-50">
    <button onclick="toggleTheme()" class="p-3 rounded-2xl shadow-sm bg-[var(--bg-secondary)] border border-[var(--border-color)]">
      <span id="theme-icon"></span>
    </button>
  </header>

  <section id="view-form" class="view-section active px-5">
    <form id="expenseForm">
      <input type="number" id="amount" step="0.01" placeholder="0.00" inputmode="decimal" required>
      <div id="movementTypeGroup" class="flex p-1 rounded-2xl mb-8 bg-[var(--bg-switch)]">
        <button type="button" class="flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-md" data-value="Compra">Gasto</button>
        <button type="button" class="flex-1 py-3 rounded-xl font-bold transition-all text-slate-500" data-value="Ingreso">Ingreso</button>
      </div>
      <input type="hidden" id="movementType" value="Compra">
      <div class="space-y-6">
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Descripción</label>
          <input type="text" id="description" class="input-base" placeholder="¿En qué?" required>
          <div id="suggestions-container" class="scroll-container mt-2"></div>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Categoría</label>
          <div id="categoryGroup" class="scroll-container"></div>
          <input type="hidden" id="expenseType" required>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">Pago</label>
          <div id="paymentMethodGroup" class="scroll-container"></div>
          <input type="hidden" id="paymentMethod" required>
        </div>
      </div>
      <button type="submit" class="w-full py-4 mt-8 bg-blue-600 text-white font-bold rounded-2xl shadow-xl active:scale-95 transition-all">Registrar</button>
    </form>
  </section>

  <section id="view-list" class="view-section px-5">
    <div class="flex gap-2 mb-4">
      <input type="date" id="list-from" class="date-picker-custom">
      <input type="date" id="list-to" class="date-picker-custom">
      <button onclick="loadAppData('list')" class="p-3 bg-blue-600 text-white rounded-xl">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5"/></svg>
      </button>
    </div>
    <div id="records-container"></div>
  </section>

  <section id="view-stats" class="view-section px-5">
    <div class="flex gap-2 mb-6">
      <input type="date" id="stats-from" class="date-picker-custom">
      <input type="date" id="stats-to" class="date-picker-custom">
      <button onclick="loadAppData('stats')" class="p-3 bg-blue-600 text-white rounded-xl">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5"/></svg>
      </button>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="p-4 bg-green-500/10 rounded-2xl border-l-4 border-green-500 text-green-600">
        <span class="text-[10px] font-black uppercase">Ingresos</span>
        <p id="stat-income" class="text-xl font-black">$0</p>
      </div>
      <div class="p-4 bg-rose-500/10 rounded-2xl border-l-4 border-rose-500 text-rose-600">
        <span class="text-[10px] font-black uppercase">Gastos</span>
        <p id="stat-expense" class="text-xl font-black">$0</p>
      </div>
    </div>
    <div class="bg-[var(--bg-secondary)] p-4 rounded-3xl border border-[var(--border-color)]">
      <canvas id="chartStats"></canvas>
    </div>
  </section>

  <nav class="nav-floating">
    <button onclick="switchView('form')" id="nav-btn-form" class="flex flex-col items-center p-3 text-blue-600"><span class="text-[10px] font-bold">NUEVO</span></button>
    <button onclick="switchView('list')" id="nav-btn-list" class="flex flex-col items-center p-3 text-slate-400"><span class="text-[10px] font-bold">HISTORIAL</span></button>
    <button onclick="switchView('stats')" id="nav-btn-stats" class="flex flex-col items-center p-3 text-slate-400"><span class="text-[10px] font-bold">STATS</span></button>
  </nav>

<script>
  const $ = id => document.getElementById(id);
  let chart = null;

  const ICONS = {
    sun: `<svg class="w-6 h-6 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>`,
    moon: `<svg class="w-6 h-6 text-slate-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>`
  };

  const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];

  function toggleTheme() {
    const isDark = document.documentElement.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    $('theme-icon').innerHTML = isDark ? ICONS.sun : ICONS.moon;
  }

  function switchView(id) {
    document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
    $(`view-${id}`).classList.add('active');
    document.querySelectorAll('.nav-floating button').forEach(b => b.classList.replace('text-blue-600', 'text-slate-400'));
    $(`nav-btn-${id}`).classList.replace('text-slate-400', 'text-blue-600');
    if (id !== 'form') loadAppData(id);
  }

  function loadAppData(view) {
    const from = $(view + '-from').value;
    const to = $(view + '-to').value;
    $('loading-overlay').style.display = 'flex';

    google.script.run.withSuccessHandler(data => {
      const filtered = data.records.filter(r => {
        const d = r.fecha.split('/').reverse().join('-');
        return d >= from && d <= to;
      });
      view === 'list' ? renderList(filtered) : renderStats(filtered);
      $('loading-overlay').style.display = 'none';
    }).getAppData();
  }

  function renderList(records) {
    $('records-container').innerHTML = records.map(r => `
      <div class="record-card flex justify-between items-center shadow-sm">
        <div>
          <p class="font-bold">${r.desc}</p>
          <p class="text-[10px] text-slate-400 font-bold uppercase">${r.fecha} • ${r.cat}</p>
        </div>
        <div class="text-right">
          <p class="font-black text-lg ${r.tipo === 'Ingreso' ? 'text-green-600' : 'text-rose-500'}">
            ${r.tipo === 'Ingreso' ? '+' : '-'}$${r.monto.toLocaleString()}
          </p>
          <p class="text-[9px] text-slate-400 font-bold uppercase">${r.pago}</p>
        </div>
      </div>`).join('');
  }

  function renderStats(records) {
    const income = records.filter(r => r.tipo === 'Ingreso').reduce((a, b) => a + b.monto, 0);
    const expense = records.filter(r => r.tipo === 'Compra').reduce((a, b) => a + b.monto, 0);
    $('stat-income').innerText = `$${income.toLocaleString()}`;
    $('stat-expense').innerText = `$${expense.toLocaleString()}`;

    const cats = {};
    records.filter(r => r.tipo === 'Compra').forEach(r => cats[r.cat] = (cats[r.cat] || 0) + r.monto);

    if (chart) chart.destroy();
    chart = new Chart($('chartStats'), {
      type: 'doughnut',
      data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: COLORS, borderWidth: 0 }] },
      options: { plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { weight: 'bold', size: 10 } } } } }
    });
  }

  function select(btn, inputId, value) {
    btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    $(inputId).value = value;
  }

  function populateButtons(containerId, items, inputId) {
    const container = $(containerId);
    items.forEach(item => {
      container.innerHTML += `<button type="button" class="scroll-button" onclick="select(this,'${inputId}','${item}')">${item}</button>`;
    });
  }

  function resetForm() {
    $('expenseForm').reset();
    $('amount').value = '';
    document.querySelectorAll('.scroll-button').forEach(b => b.classList.remove('selected'));
    $('loader-spinner').classList.remove('hidden');
    $('loader-success').classList.add('hidden');
    $('loading-text').innerText = 'Cargando...';
  }

  $('expenseForm').onsubmit = e => {
    e.preventDefault();
    $('loading-overlay').style.display = 'flex';
    $('loading-text').innerText = 'Guardando...';

    google.script.run.withSuccessHandler(() => {
      $('loader-spinner').classList.add('hidden');
      $('loader-success').classList.remove('hidden');
      setTimeout(() => {
        $('loading-overlay').style.display = 'none';
        resetForm();
      }, 1000);
    }).recordExpense({
      amount: $('amount').value,
      description: $('description').value,
      movementType: $('movementType').value,
      expenseType: $('expenseType').value,
      paymentMethod: $('paymentMethod').value
    });
  };

  $('movementTypeGroup').onclick = e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    btn.parentElement.querySelectorAll('button').forEach(b => b.className = 'flex-1 py-3 rounded-xl font-bold transition-all text-slate-500');
    btn.className = 'flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-md';
    $('movementType').value = btn.dataset.value;
  };

  window.onload = () => {
    const isDark = localStorage.getItem('theme') === 'dark';
    if (isDark) document.documentElement.classList.add('dark-mode');
    $('theme-icon').innerHTML = isDark ? ICONS.sun : ICONS.moon;

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = now.toISOString().split('T')[0];
    ['list-from', 'stats-from'].forEach(id => $(id).value = firstDay);
    ['list-to', 'stats-to'].forEach(id => $(id).value = today);

    google.script.run.withSuccessHandler(res => populateButtons('categoryGroup', res, 'expenseType')).getCategories();
    google.script.run.withSuccessHandler(res => populateButtons('paymentMethodGroup', res, 'paymentMethod')).getPaymentMethods();
    google.script.run.withSuccessHandler(res => {
      res.forEach(d => $('suggestions-container').innerHTML += `<button type="button" class="scroll-button" onclick="$('description').value='${d}'">${d}</button>`);
    }).getCommonDescriptions();
  };
</script>
</body>
</html>
