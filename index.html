<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --text-color: #1e293b; --border-color: #e2e8f0; --bg-switch: #f1f5f9; }
    .dark-mode { --bg-primary: #0f172a; --bg-secondary: #1e293b; --text-color: #f1f5f9; --border-color: #334155; --bg-switch: #334155; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-primary); color: var(--text-color); height: 100vh; overflow: hidden; }
    .input-base { width: 100%; padding: 1rem; border-radius: 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); outline: none; }
    #amount { font-size: 4.5rem; font-weight: 800; color: #3b82f6; text-align: center; border: none; background: transparent; outline: none; width: 100%; }
    .scroll-container { display: flex; overflow-x: auto; gap: 0.6rem; padding: 0.5rem 0; scrollbar-width: none; }
    .scroll-container::-webkit-scrollbar { display: none; }
    .scroll-button { flex: 0 0 auto; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600; border-radius: 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); cursor: pointer; }
    .scroll-button.selected { background: #3b82f6 !important; color: white !important; border-color: #3b82f6; }
    .nav-floating { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 2rem; padding: 0.5rem; display: flex; justify-content: space-around; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); z-index: 1000; }
    .view-section { flex: 1; overflow-y: auto; display: none; padding-bottom: 120px; height: calc(100vh - 80px); }
    .view-section.active { display: block; }
    .record-card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1.25rem; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: transform 0.1s; }
    .record-card:active { transform: scale(0.98); }
    .date-picker-custom { background: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 0.75rem; padding: 0.5rem; font-size: 0.8rem; font-weight: 700; outline: none; flex: 1; }
    #loading-overlay { position: fixed; inset: 0; background: var(--bg-primary); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
    .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .header-btn { padding: 0.75rem; border-radius: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); background: var(--bg-secondary); border: 1px solid var(--border-color); cursor: pointer; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: var(--bg-secondary); border-radius: 1.5rem; padding: 1.5rem; width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
    .dropdown-container { position: relative; }
    .dropdown-search { width: 100%; padding: 0.75rem 1rem; border-radius: 1rem; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); outline: none; }
    .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 1rem; margin-top: 0.5rem; max-height: 200px; overflow-y: auto; z-index: 100; display: none; }
    .dropdown-list.active { display: block; }
    .dropdown-item { padding: 0.75rem 1rem; cursor: pointer; }
    .dropdown-item:hover, .dropdown-item.selected { background: #3b82f6; color: white; }
    .filter-chip { padding: 0.4rem 0.8rem; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-color); cursor: pointer; }
    .filter-chip.active { background: #3b82f6; color: white; border-color: #3b82f6; }
    .config-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border-color); }
    .toggle-switch { width: 50px; height: 28px; background: var(--border-color); border-radius: 14px; position: relative; cursor: pointer; transition: background 0.2s; }
    .toggle-switch.active { background: #3b82f6; }
    .toggle-switch::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 2px; left: 2px; transition: transform 0.2s; }
    .toggle-switch.active::after { transform: translateX(22px); }
    .tag { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.8rem; font-size: 0.8rem; background: var(--bg-switch); border-radius: 9999px; margin: 0.25rem; }
    .tag-remove { cursor: pointer; opacity: 0.6; }
    .tag-remove:hover { opacity: 1; }
  </style>
</head>
<body>
  <div id="loading-overlay">
    <div id="loader-spinner" class="spinner mb-4"></div>
    <div id="loader-success" class="hidden mb-4"><svg class="w-12 h-12 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M5 13l4 4L19 7" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
    <p id="loading-text" class="font-black text-blue-600 uppercase tracking-widest text-xs" data-i18n="loading">Loading...</p>
  </div>

  <header class="flex justify-end items-center gap-2 p-4 sticky top-0 bg-[var(--bg-primary)] z-50">
    <button onclick="openConfig()" class="header-btn">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    </button>
    <button onclick="toggleTheme()" class="header-btn">
      <span id="theme-icon"></span>
    </button>
  </header>

  <!-- FORM VIEW -->
  <section id="view-form" class="view-section active px-5">
    <form id="expenseForm">
      <input type="number" id="amount" step="0.01" placeholder="0.00" inputmode="decimal" required>
      <div id="movementTypeGroup" class="flex p-1 rounded-2xl mb-8 bg-[var(--bg-switch)]">
        <button type="button" class="flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-md" data-value="Compra" data-i18n="expense">Expense</button>
        <button type="button" class="flex-1 py-3 rounded-xl font-bold transition-all text-slate-500" data-value="Ingreso" data-i18n="income">Income</button>
      </div>
      <input type="hidden" id="movementType" value="Compra">
      <div class="space-y-6">
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="description">Description</label>
          <input type="text" id="description" class="input-base" data-i18n-placeholder="descriptionPlaceholder" placeholder="What for?" required>
          <div id="suggestions-container" class="scroll-container mt-2"></div>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="category">Category</label>
          <div id="categoryGroup" class="scroll-container"></div>
          <div id="categoryDropdown" class="dropdown-container hidden">
            <input type="text" class="dropdown-search" id="categorySearch" placeholder="Search category...">
            <div class="dropdown-list" id="categoryList"></div>
          </div>
          <input type="hidden" id="expenseType" required>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="payment">Payment</label>
          <div id="paymentMethodGroup" class="scroll-container"></div>
          <div id="paymentDropdown" class="dropdown-container hidden">
            <input type="text" class="dropdown-search" id="paymentSearch" placeholder="Search payment...">
            <div class="dropdown-list" id="paymentList"></div>
          </div>
          <input type="hidden" id="paymentMethod" required>
        </div>
      </div>
      <button type="submit" class="w-full py-4 mt-8 bg-blue-600 text-white font-bold rounded-2xl shadow-xl active:scale-95 transition-all" data-i18n="register">Register</button>
    </form>
  </section>

  <!-- LIST VIEW -->
  <section id="view-list" class="view-section px-5">
    <div class="space-y-3 mb-4">
      <div class="flex gap-2">
        <input type="date" id="list-from" class="date-picker-custom">
        <input type="date" id="list-to" class="date-picker-custom">
        <button onclick="loadAppData('list')" class="p-3 bg-blue-600 text-white rounded-xl">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5"/></svg>
        </button>
      </div>
      <div class="flex gap-2 flex-wrap">
        <select id="filter-category" class="date-picker-custom" onchange="applyFilters()">
          <option value="" data-i18n="allCategories">All categories</option>
        </select>
        <input type="text" id="filter-description" class="date-picker-custom flex-1" placeholder="Search description..." oninput="applyFilters()">
      </div>
    </div>
    <div id="records-container"></div>
  </section>

  <!-- STATS VIEW -->
  <section id="view-stats" class="view-section px-5">
    <div class="flex gap-2 mb-6">
      <input type="date" id="stats-from" class="date-picker-custom">
      <input type="date" id="stats-to" class="date-picker-custom">
      <button onclick="loadAppData('stats')" class="p-3 bg-blue-600 text-white rounded-xl">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" stroke-width="2.5"/></svg>
      </button>
    </div>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="p-4 bg-green-500/10 rounded-2xl border-l-4 border-green-500 text-green-600">
        <span class="text-[10px] font-black uppercase" data-i18n="incomeLabel">Income</span>
        <p id="stat-income" class="text-xl font-black">$0</p>
      </div>
      <div class="p-4 bg-rose-500/10 rounded-2xl border-l-4 border-rose-500 text-rose-600">
        <span class="text-[10px] font-black uppercase" data-i18n="expenseLabel">Expenses</span>
        <p id="stat-expense" class="text-xl font-black">$0</p>
      </div>
    </div>
    <div class="bg-[var(--bg-secondary)] p-4 rounded-3xl border border-[var(--border-color)]">
      <canvas id="chartStats"></canvas>
    </div>
  </section>

  <!-- CONFIG MODAL -->
  <div id="config-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold" data-i18n="settings">Settings</h2>
        <button onclick="closeConfig()" class="p-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <div class="config-item">
        <span class="font-semibold" data-i18n="language">Language</span>
        <select id="config-lang" class="date-picker-custom w-24" onchange="updateConfig()">
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </div>

      <div class="config-item">
        <span class="font-semibold" data-i18n="selectorStyle">Selector Style</span>
        <select id="config-selector" class="date-picker-custom w-28" onchange="updateConfig()">
          <option value="carousel" data-i18n="carousel">Carousel</option>
          <option value="dropdown" data-i18n="dropdown">Dropdown</option>
        </select>
      </div>

      <div class="config-item">
        <span class="font-semibold" data-i18n="showSuggestions">Show Suggestions</span>
        <div id="config-suggestions" class="toggle-switch active" onclick="toggleSuggestions()"></div>
      </div>

      <div class="mt-6">
        <h3 class="text-sm font-bold text-slate-400 uppercase mb-3" data-i18n="categories">Categories</h3>
        <div id="categories-list" class="flex flex-wrap mb-3"></div>
        <div class="flex gap-2">
          <input type="text" id="new-category" class="input-base flex-1" data-i18n-placeholder="newCategory" placeholder="New category">
          <button onclick="addNewCategory()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-xl">+</button>
        </div>
      </div>

      <div class="mt-6">
        <h3 class="text-sm font-bold text-slate-400 uppercase mb-3" data-i18n="paymentMethods">Payment Methods</h3>
        <div id="payments-list" class="flex flex-wrap mb-3"></div>
        <div class="flex gap-2">
          <input type="text" id="new-payment" class="input-base flex-1" data-i18n-placeholder="newPayment" placeholder="New payment method">
          <button onclick="addNewPayment()" class="px-4 py-2 bg-blue-600 text-white font-bold rounded-xl">+</button>
        </div>
      </div>
    </div>
  </div>

  <!-- EDIT RECORD MODAL -->
  <div id="edit-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold" data-i18n="editRecord">Edit Record</h2>
        <button onclick="closeEditModal()" class="p-2">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>

      <form id="editForm" class="space-y-4">
        <input type="hidden" id="edit-id">
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="date">Date</label>
          <input type="date" id="edit-date" class="input-base" required>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="amount">Amount</label>
          <input type="number" id="edit-amount" step="0.01" class="input-base" required>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="description">Description</label>
          <input type="text" id="edit-description" class="input-base" required>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="type">Type</label>
          <select id="edit-type" class="input-base">
            <option value="Compra" data-i18n="expense">Expense</option>
            <option value="Ingreso" data-i18n="income">Income</option>
          </select>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="category">Category</label>
          <select id="edit-category" class="input-base"></select>
        </div>
        <div>
          <label class="block text-[10px] font-black text-slate-400 uppercase mb-2" data-i18n="payment">Payment</label>
          <select id="edit-payment" class="input-base"></select>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="deleteCurrentRecord()" class="flex-1 py-3 bg-rose-500 text-white font-bold rounded-xl" data-i18n="delete">Delete</button>
          <button type="submit" class="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl" data-i18n="save">Save</button>
        </div>
      </form>
    </div>
  </div>

  <nav class="nav-floating">
    <button onclick="switchView('form')" id="nav-btn-form" class="flex flex-col items-center p-3 text-blue-600"><span class="text-[10px] font-bold" data-i18n="navNew">NEW</span></button>
    <button onclick="switchView('list')" id="nav-btn-list" class="flex flex-col items-center p-3 text-slate-400"><span class="text-[10px] font-bold" data-i18n="navHistory">HISTORY</span></button>
    <button onclick="switchView('stats')" id="nav-btn-stats" class="flex flex-col items-center p-3 text-slate-400"><span class="text-[10px] font-bold" data-i18n="navStats">STATS</span></button>
  </nav>

<script>
const $ = id => document.getElementById(id);
let chart = null;
let currentLang = 'en';
let appConfig = {};
let allRecords = [];

const ICONS = {
  sun: `<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"/></svg>`,
  moon: `<svg class="w-5 h-5 text-slate-400" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>`
};

const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

const I18N = {
  en: {
    loading: 'Loading...', saving: 'Saving...', expense: 'Expense', income: 'Income',
    description: 'Description', descriptionPlaceholder: 'What for?', category: 'Category',
    payment: 'Payment', register: 'Register', navNew: 'NEW', navHistory: 'HISTORY', navStats: 'STATS',
    incomeLabel: 'Income', expenseLabel: 'Expenses', settings: 'Settings', language: 'Language',
    selectorStyle: 'Selector Style', carousel: 'Carousel', dropdown: 'Dropdown',
    showSuggestions: 'Show Suggestions', categories: 'Categories', paymentMethods: 'Payment Methods',
    newCategory: 'New category', newPayment: 'New payment method', editRecord: 'Edit Record',
    date: 'Date', amount: 'Amount', type: 'Type', delete: 'Delete', save: 'Save',
    allCategories: 'All categories', confirmDelete: 'Delete this record?'
  },
  es: {
    loading: 'Cargando...', saving: 'Guardando...', expense: 'Gasto', income: 'Ingreso',
    description: 'Descripción', descriptionPlaceholder: '¿En qué?', category: 'Categoría',
    payment: 'Pago', register: 'Registrar', navNew: 'NUEVO', navHistory: 'HISTORIAL', navStats: 'STATS',
    incomeLabel: 'Ingresos', expenseLabel: 'Gastos', settings: 'Configuración', language: 'Idioma',
    selectorStyle: 'Estilo Selector', carousel: 'Carrusel', dropdown: 'Desplegable',
    showSuggestions: 'Mostrar Sugerencias', categories: 'Categorías', paymentMethods: 'Métodos de Pago',
    newCategory: 'Nueva categoría', newPayment: 'Nuevo método de pago', editRecord: 'Editar Registro',
    date: 'Fecha', amount: 'Monto', type: 'Tipo', delete: 'Eliminar', save: 'Guardar',
    allCategories: 'Todas las categorías', confirmDelete: '¿Eliminar este registro?'
  }
};

function t(key) { return I18N[currentLang][key] || key; }

function applyLanguage() {
  document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.dataset.i18n));
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.dataset.i18nPlaceholder));
  document.documentElement.lang = currentLang;
}

function toggleTheme() {
  const isDark = document.documentElement.classList.toggle('dark-mode');
  appConfig.theme = isDark ? 'dark' : 'light';
  $('theme-icon').innerHTML = isDark ? ICONS.sun : ICONS.moon;
  saveConfigToServer();
}

function openConfig() {
  $('config-modal').classList.add('active');
  $('config-lang').value = currentLang;
  $('config-selector').value = appConfig.selectorStyle || 'carousel';
  $('config-suggestions').classList.toggle('active', appConfig.showSuggestions !== false);
  renderCategoriesList();
  renderPaymentsList();
}

function closeConfig() { $('config-modal').classList.remove('active'); }

function toggleSuggestions() {
  const toggle = $('config-suggestions');
  toggle.classList.toggle('active');
  appConfig.showSuggestions = toggle.classList.contains('active');
  updateSuggestionsVisibility();
  saveConfigToServer();
}

function updateConfig() {
  currentLang = $('config-lang').value;
  appConfig.lang = currentLang;
  appConfig.selectorStyle = $('config-selector').value;
  applyLanguage();
  applySelectorStyle();
  saveConfigToServer();
}

function saveConfigToServer() {
  google.script.run.saveConfig(appConfig);
}

function applySelectorStyle() {
  const isDropdown = appConfig.selectorStyle === 'dropdown';
  $('categoryGroup').classList.toggle('hidden', isDropdown);
  $('categoryDropdown').classList.toggle('hidden', !isDropdown);
  $('paymentMethodGroup').classList.toggle('hidden', isDropdown);
  $('paymentDropdown').classList.toggle('hidden', !isDropdown);
}

function updateSuggestionsVisibility() {
  $('suggestions-container').classList.toggle('hidden', !appConfig.showSuggestions);
}

function renderCategoriesList() {
  const container = $('categories-list');
  container.innerHTML = (appConfig.categories || []).map(c =>
    `<span class="tag">${c}<span class="tag-remove" onclick="removeCategory('${c}')">×</span></span>`
  ).join('');
}

function renderPaymentsList() {
  const container = $('payments-list');
  container.innerHTML = (appConfig.paymentMethods || []).map(p =>
    `<span class="tag">${p}<span class="tag-remove" onclick="removePayment('${p}')">×</span></span>`
  ).join('');
}

function addNewCategory() {
  const input = $('new-category');
  const value = input.value.trim();
  if (!value) return;

  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      appConfig.categories = res.categories;
      renderCategoriesList();
      populateSelectors();
      input.value = '';
    }
  }).addCategory(value);
}

function removeCategory(cat) {
  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      appConfig.categories = res.categories;
      renderCategoriesList();
      populateSelectors();
    }
  }).removeCategory(cat);
}

function addNewPayment() {
  const input = $('new-payment');
  const value = input.value.trim();
  if (!value) return;

  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      appConfig.paymentMethods = res.paymentMethods;
      renderPaymentsList();
      populateSelectors();
      input.value = '';
    }
  }).addPaymentMethod(value);
}

function removePayment(method) {
  google.script.run.withSuccessHandler(res => {
    if (res.success) {
      appConfig.paymentMethods = res.paymentMethods;
      renderPaymentsList();
      populateSelectors();
    }
  }).removePaymentMethod(method);
}

function populateSelectors() {
  const categories = appConfig.categories || [];
  const payments = appConfig.paymentMethods || [];

  // Carousel style
  $('categoryGroup').innerHTML = categories.map(c =>
    `<button type="button" class="scroll-button" onclick="select(this,'expenseType','${c}')">${c}</button>`
  ).join('');

  $('paymentMethodGroup').innerHTML = payments.map(p =>
    `<button type="button" class="scroll-button" onclick="select(this,'paymentMethod','${p}')">${p}</button>`
  ).join('');

  // Dropdown style
  $('categoryList').innerHTML = categories.map(c =>
    `<div class="dropdown-item" onclick="selectDropdown('expenseType','${c}', this)">${c}</div>`
  ).join('');

  $('paymentList').innerHTML = payments.map(p =>
    `<div class="dropdown-item" onclick="selectDropdown('paymentMethod','${p}', this)">${p}</div>`
  ).join('');

  // Edit modal selects
  $('edit-category').innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
  $('edit-payment').innerHTML = payments.map(p => `<option value="${p}">${p}</option>`).join('');

  // Filter select
  const filterCat = $('filter-category');
  filterCat.innerHTML = `<option value="">${t('allCategories')}</option>` +
    categories.map(c => `<option value="${c}">${c}</option>`).join('');
}

function select(btn, inputId, value) {
  btn.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  $(inputId).value = value;
}

function selectDropdown(inputId, value, el) {
  $(inputId).value = value;
  const searchId = inputId === 'expenseType' ? 'categorySearch' : 'paymentSearch';
  $(searchId).value = value;
  el.parentElement.classList.remove('active');
}

function setupDropdowns() {
  ['category', 'payment'].forEach(type => {
    const searchId = type === 'category' ? 'categorySearch' : 'paymentSearch';
    const listId = type === 'category' ? 'categoryList' : 'paymentList';

    $(searchId).addEventListener('focus', () => $(listId).classList.add('active'));
    $(searchId).addEventListener('input', e => {
      const query = e.target.value.toLowerCase();
      $(listId).querySelectorAll('.dropdown-item').forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(query) ? 'block' : 'none';
      });
    });
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.dropdown-container')) {
      document.querySelectorAll('.dropdown-list').forEach(l => l.classList.remove('active'));
    }
  });
}

function switchView(id) {
  document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
  $(`view-${id}`).classList.add('active');
  document.querySelectorAll('.nav-floating button').forEach(b => b.classList.replace('text-blue-600', 'text-slate-400'));
  $(`nav-btn-${id}`).classList.replace('text-slate-400', 'text-blue-600');
  if (id !== 'form') loadAppData(id);
}

function loadAppData(view) {
  const from = $(view + '-from').value;
  const to = $(view + '-to').value;
  showLoading();

  google.script.run.withSuccessHandler(data => {
    allRecords = data.records.filter(r => {
      const d = r.fecha.split('/').reverse().join('-');
      return d >= from && d <= to;
    });
    view === 'list' ? renderList(allRecords) : renderStats(allRecords);
    hideLoading();
  }).getAppData();
}

function applyFilters() {
  const catFilter = $('filter-category').value;
  const descFilter = $('filter-description').value.toLowerCase();

  const filtered = allRecords.filter(r => {
    const matchCat = !catFilter || r.cat === catFilter;
    const matchDesc = !descFilter || r.desc.toLowerCase().includes(descFilter);
    return matchCat && matchDesc;
  });

  renderList(filtered);
}

function renderList(records) {
  $('records-container').innerHTML = records.map(r => `
    <div class="record-card flex justify-between items-center shadow-sm" onclick="openEditModal(${r.id}, '${r.fechaISO}', ${r.monto}, '${r.desc.replace(/'/g, "\\'")}', '${r.tipo}', '${r.cat}', '${r.pago}')">
      <div>
        <p class="font-bold">${r.desc}</p>
        <p class="text-[10px] text-slate-400 font-bold uppercase">${r.fecha} • ${r.cat}</p>
      </div>
      <div class="text-right">
        <p class="font-black text-lg ${r.tipo === 'Ingreso' ? 'text-green-600' : 'text-rose-500'}">
          ${r.tipo === 'Ingreso' ? '+' : '-'}$${r.monto.toLocaleString()}
        </p>
        <p class="text-[9px] text-slate-400 font-bold uppercase">${r.pago}</p>
      </div>
    </div>`).join('');
}

function openEditModal(id, date, amount, desc, type, cat, payment) {
  $('edit-id').value = id;
  $('edit-date').value = date;
  $('edit-amount').value = amount;
  $('edit-description').value = desc;
  $('edit-type').value = type;
  $('edit-category').value = cat;
  $('edit-payment').value = payment;
  $('edit-modal').classList.add('active');
}

function closeEditModal() { $('edit-modal').classList.remove('active'); }

function deleteCurrentRecord() {
  if (!confirm(t('confirmDelete'))) return;
  const id = $('edit-id').value;
  showLoading();

  google.script.run.withSuccessHandler(res => {
    closeEditModal();
    loadAppData('list');
  }).deleteRecord(id);
}

$('editForm').onsubmit = e => {
  e.preventDefault();
  showLoading();

  google.script.run.withSuccessHandler(res => {
    closeEditModal();
    loadAppData('list');
  }).updateRecord($('edit-id').value, {
    date: $('edit-date').value,
    amount: $('edit-amount').value,
    description: $('edit-description').value,
    movementType: $('edit-type').value,
    expenseType: $('edit-category').value,
    paymentMethod: $('edit-payment').value
  });
};

function renderStats(records) {
  const income = records.filter(r => r.tipo === 'Ingreso').reduce((a, b) => a + b.monto, 0);
  const expense = records.filter(r => r.tipo === 'Compra').reduce((a, b) => a + b.monto, 0);
  $('stat-income').innerText = `$${income.toLocaleString()}`;
  $('stat-expense').innerText = `$${expense.toLocaleString()}`;

  const cats = {};
  records.filter(r => r.tipo === 'Compra').forEach(r => cats[r.cat] = (cats[r.cat] || 0) + r.monto);

  if (chart) chart.destroy();
  chart = new Chart($('chartStats'), {
    type: 'doughnut',
    data: { labels: Object.keys(cats), datasets: [{ data: Object.values(cats), backgroundColor: COLORS, borderWidth: 0 }] },
    options: { plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { weight: 'bold', size: 10 } } } } }
  });
}

function showLoading() { $('loading-overlay').style.display = 'flex'; }
function hideLoading() { $('loading-overlay').style.display = 'none'; }

function resetForm() {
  $('expenseForm').reset();
  $('amount').value = '';
  document.querySelectorAll('.scroll-button').forEach(b => b.classList.remove('selected'));
  $('loader-spinner').classList.remove('hidden');
  $('loader-success').classList.add('hidden');
  $('loading-text').innerText = t('loading');
  $('categorySearch').value = '';
  $('paymentSearch').value = '';
}

$('expenseForm').onsubmit = e => {
  e.preventDefault();
  showLoading();
  $('loading-text').innerText = t('saving');

  google.script.run.withSuccessHandler(() => {
    $('loader-spinner').classList.add('hidden');
    $('loader-success').classList.remove('hidden');
    setTimeout(() => { hideLoading(); resetForm(); }, 1000);
  }).recordExpense({
    amount: $('amount').value,
    description: $('description').value,
    movementType: $('movementType').value,
    expenseType: $('expenseType').value,
    paymentMethod: $('paymentMethod').value
  });
};

$('movementTypeGroup').onclick = e => {
  const btn = e.target.closest('button');
  if (!btn) return;
  btn.parentElement.querySelectorAll('button').forEach(b => b.className = 'flex-1 py-3 rounded-xl font-bold transition-all text-slate-500');
  btn.className = 'flex-1 py-3 rounded-xl font-bold transition-all bg-blue-600 text-white shadow-md';
  $('movementType').value = btn.dataset.value;
};

window.onload = () => {
  google.script.run.withSuccessHandler(config => {
    appConfig = config;
    currentLang = config.lang || 'en';

    const isDark = config.theme === 'dark';
    if (isDark) document.documentElement.classList.add('dark-mode');
    $('theme-icon').innerHTML = isDark ? ICONS.sun : ICONS.moon;

    applyLanguage();
    populateSelectors();
    applySelectorStyle();
    updateSuggestionsVisibility();
    setupDropdowns();

    const now = new Date();
    const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
    const today = now.toISOString().split('T')[0];
    ['list-from', 'stats-from'].forEach(id => $(id).value = firstDay);
    ['list-to', 'stats-to'].forEach(id => $(id).value = today);

    if (config.showSuggestions !== false) {
      google.script.run.withSuccessHandler(res => {
        $('suggestions-container').innerHTML = res.map(d =>
          `<button type="button" class="scroll-button" onclick="$('description').value='${d}'">${d}</button>`
        ).join('');
      }).getCommonDescriptions();
    }

    hideLoading();
  }).getConfig();
};
</script>
</body>
</html>
